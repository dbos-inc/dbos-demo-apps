<!DOCTYPE html>
<html lang="en">
<head>
    <title>Welcome to DBOS!</title>
    <link rel="icon" href="https://dbos-blog-posts.s3.us-west-1.amazonaws.com/live-demo/favicon.ico" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="font-sans text-gray-800 p-6 max-w-2xl mx-auto">
    <script>
        // Generate 6-character random string
        function generateRandomString() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            return Array.from(crypto.getRandomValues(new Uint8Array(6)))
                .map(x => chars[x % chars.length])
                .join('');
        }
    </script>
    <h1 class="text-xl font-semibold mb-4">Welcome to DBOS!</h1>
    <p class="mb-4">
        DBOS helps you build <strong>crashproof</strong> applications&mdash;no matter how many times you crash this app, your background task will always recover.
    </p>
    <div class="flex gap-4 mb-4">
        <button
            onclick="startBackgroundJob()"
            class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded shadow transition duration-150 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50"
        >
            Launch a reliable background task
        </button>
        <button
            onclick="crashApp()"
            class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded shadow transition duration-150 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50"
        >
            Crash the application
        </button>
    </div>
    <p id="status" class="mb-4 text-gray-600"></p>
    <script>
        let intervalId;
        let currentId = null;

        // Check URL for existing ID on page load
        const urlParams = new URLSearchParams(window.location.search);
        const urlId = urlParams.get('id');
        if (urlId && urlId.length === 6) {
            currentId = urlId;
            checkProgress();
            intervalId = setInterval(checkProgress, 500);
        }

        async function crashApp() {
            await fetch('/crash', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
        }

        async function startBackgroundJob() {
            const randomString = generateRandomString();
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.set('id', randomString);
            window.history.replaceState({}, '', `${window.location.pathname}?${urlParams.toString()}`);
           
            currentId = randomString;
            await fetch(`/background/${currentId}/10`, { method: 'GET' });
           
            // Start checking progress only after starting the job
            checkProgress();
            if (intervalId) clearInterval(intervalId);
            intervalId = setInterval(checkProgress, 500);
        }
       
        async function checkProgress() {
            if (!currentId) return;
           
            try {
                const response = await fetch(`/last_step/${currentId}`);
                const step = await response.text();
                document.getElementById('status').textContent = `Your background task has completed ${step} of 10 steps`;
            } catch (error) {
                console.error('Error checking progress:', error);
            }
        }
    </script>
    <p class="mb-4">
        To start building your own crashproof application, edit <code class="bg-gray-100 px-1 rounded">app/main.py</code>, commit your changes, then visit the <a href="https://console.dbos.dev/applications/dbos-fastapi-starter" target="_blank" class="text-blue-600 hover:underline">cloud console</a> to redeploy your app.
    </p>
    <p class="mb-4">
        To learn how to build crashproof apps with DBOS, visit the <a href="https://docs.dbos.dev/python/programming-guide" target="_blank" class="text-blue-600 hover:underline">docs</a>!
    </p>
</body>
</html>